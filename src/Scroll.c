#include "Scroll.h"

#include "Classification.h"
#include "util.h"

#include <assert.h>
#include <float.h>

static float err(const float a, const float b)
{
    return 0.5f * (a - b) * (a - b);
}

static float toterr(int* a, int* b, const int size)
{
    float sum = 0.0f;
    for(int i = 0; i < size; i++)
        sum += err(a[i], b[i]);
    return sum;
}

void s_clear(const Scroll sc)
{
    for(int i = 0; i < sc.squares; i++)
        sc.casting[i] = 0;
}

int s_index(const Scroll sc)
{
    float min = FLT_MAX;
    int index = 0;
    for(int i = 0; i < sc.scrolls; i++)
    {
        const float err = toterr(sc.casting, sc.castables[i], sc.squares);
        if(err < min)
        {
            min = err;
            index = i;
        }
    }
    return index;
}

Scroll s_new(void)
{
    #define SCROLLS 24
    #define WIDTH    9
    #define SQUARES (WIDTH * WIDTH)

    // Not doing VLAs for C++ compatability so this check is necessary.
    assert(SCROLLS == c_indices(SCROLL));

    static int runes[SCROLLS][SQUARES] = {
        {
            0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,1,0,1,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,1,0,1,0,0,0,
            0,0,1,0,0,0,1,0,0,
            0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,1,0,0,0,0,0,1,0,
            0,1,1,0,0,0,1,1,0,
            0,1,0,1,0,1,0,1,0,
            0,1,0,0,1,0,0,1,0,
            0,1,0,1,0,1,0,1,0,
            0,1,1,0,0,0,1,1,0,
            0,1,0,0,0,0,0,1,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,1,1,1,0,0,0,
            0,0,1,0,1,0,1,0,0,
            0,1,0,0,1,0,0,1,0,
            0,0,1,0,0,0,1,0,0,
            0,0,0,1,0,1,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,1,0,0,0,
            0,0,0,0,1,0,1,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,
            0,0,1,0,0,0,1,0,0,
            0,0,1,1,0,1,1,0,0,
            0,0,1,0,1,0,1,0,0,
            0,0,1,1,0,1,1,0,0,
            0,0,1,0,0,0,1,0,0,
            0,0,1,0,0,0,1,0,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,
            0,0,1,0,0,0,1,0,0,
            0,0,1,1,0,1,1,0,0,
            0,0,1,0,1,0,1,0,0,
            0,0,1,0,0,0,1,0,0,
            0,0,1,0,0,0,1,0,0,
            0,0,1,0,0,0,1,0,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,1,0,0,0,
            0,0,0,0,1,0,1,0,0,
            0,0,0,0,1,1,0,0,0,
            0,0,0,0,1,0,1,0,0,
            0,0,0,0,1,1,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,1,1,1,0,0,0,
            0,0,1,0,1,0,1,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,1,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,1,0,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,0,1,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,1,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,1,0,1,0,1,0,0,
            0,0,0,1,1,1,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,1,0,0,1,0,0,0,0,
            0,1,1,1,0,0,0,0,0,
            0,1,0,0,0,0,0,0,0,
            0,1,1,1,1,0,0,0,0,
            0,1,0,0,0,0,0,0,0,
            0,1,1,1,0,0,0,0,0,
            0,1,0,0,1,0,0,0,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,1,0,0,0,
            0,0,0,0,1,0,1,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,1,0,1,0,0,0,0,
            0,0,0,1,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,0,1,0,0,0,1,0,0,
            0,0,0,1,0,1,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,1,1,1,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,1,0,1,0,0,0,
            0,0,1,0,0,0,1,0,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,1,0,1,0,0,0,0,
            0,0,0,1,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,1,0,0,0,
            0,0,0,0,1,0,1,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,0,1,0,0,0,1,0,0,
            0,0,1,0,0,0,1,0,0,
            0,0,1,1,0,0,1,0,0,
            0,0,1,0,1,0,1,0,0,
            0,0,1,0,0,1,1,0,0,
            0,0,1,0,0,0,1,0,0,
            0,0,1,0,0,0,1,0,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,1,0,0,0,
            0,0,0,0,1,0,1,0,0,
            0,0,0,0,1,1,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,1,0,0,0,0,0,1,0,
            0,0,1,0,0,0,1,0,0,
            0,0,0,1,0,1,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,1,0,1,0,0,0,
            0,0,1,0,0,0,1,0,0,
            0,1,0,0,0,0,0,1,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,1,0,
            0,0,0,0,0,0,1,0,0,
            0,0,0,0,0,1,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,0,1,0,0,0,
            0,0,0,0,0,0,1,0,0,
            0,0,0,0,0,0,0,1,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,1,0,0,0,
            0,0,0,0,1,0,1,0,0,
            0,0,0,0,1,1,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,1,0,0,0,
            0,0,0,0,1,0,1,0,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,1,0,0,0,
            0,0,0,0,1,0,1,0,0,
            0,0,0,0,1,1,0,0,0,
            0,0,0,0,1,0,1,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,1,0,0,0,
            0,0,0,0,1,0,1,0,0,
            0,0,0,0,1,1,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,1,0,0,0,
            0,0,0,0,1,0,1,0,0,
            0,0,0,0,1,0,0,1,0,
            0,0,0,0,1,0,0,1,0,
            0,0,0,0,1,0,0,1,0,
            0,0,0,0,1,0,0,1,0,
            0,0,0,0,0,0,0,0,0,
        },{
            0,0,0,0,0,0,0,0,0,
            0,0,0,0,1,0,1,0,0,
            0,0,0,0,1,1,0,0,0,
            0,0,0,0,1,0,1,0,0,
            0,0,0,0,1,1,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,1,0,0,0,0,
            0,0,0,0,0,0,0,0,0,
        }
    };

    static Scroll zero;
    Scroll sc = zero;
    sc.casting = u_toss(int, SQUARES);
    sc.castables = u_toss(int*, SCROLLS);
    sc.width = WIDTH;
    sc.squares = SQUARES;
    sc.scrolls = SCROLLS;
    for(int i = 0; i < sc.scrolls; i++)
        sc.castables[i] = runes[i];
    return sc;
}

// Converts a scroll to _one_ string with many newlines.
char* s_str(const Scroll sc, const int scindex)
{
    const int len = sc.squares + sc.width + 1;
    char* const str = u_wipe(char, len);
    memset(str, '\n', len - 1);
    for(int j = 0; j < sc.width; j++)
    for(int i = 0; i < sc.width; i++)
        str[i + j * (sc.width + 1)] = sc.castables[scindex][i + j * sc.width] ? 'x' : '-';
    return str;
}
